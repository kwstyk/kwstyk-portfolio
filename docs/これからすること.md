### まず前提をそろえます  
- **構成仕様書 v 2.0** が「理想形」  
- `https://kwstyk-portfolio.vercel.app/` は *途中品* であり、Next.js 系スターターをベースに小刻みに改造した痕跡が残っている（Astro/Tailwind の“設計図どおり”ではない）  
- ここからは **「完成形に寄せるための差分削減ロードマップ」** を示します。  

> ※ サーバー側でタイムアウトが生じ、ページ内容を直接クローリングできなかったため、以下は **Next.js Starter → Astro/Tailwind モノレポへ寄せ直す** 一般的なズレを想定して書いています。リポジトリ URL を共有いただければ、コミット単位での具体的なパス提案まで落とし込めます。

---

## 1. いま起きている典型的なズレ

| 仕様書項目 | 現サイトでよく起きるズレ例 | なぜ問題か |
|------------|---------------------------|------------|
| **フレームワーク** | Next.js の `app/` 構造が残っている | React ランタイム依存でビルドサイズ・Cold-start コスト増 |
| **Atomic Design 階層** | `components/` 直下に Card/Hero など混在 | 再利用境界が曖昧→デザイン差分が散在 |
| **Tailwind トークン同期** | `class=\"bg-[#0d1b2a]\"` の生色コードが大量 | テーマ一括変更不能、JIT パージ非効率 |
| **ページ深度** | `/proof/` と Blog 記事が同じレイアウト | ペルソナ別 UX が崩れ、情報が埋もれる |
| **データ駆動** | `proof.json` ではなく手書き `<Card>` 列挙 | 更新のたびにコンポーネント改修が必要 |
| **CI / SLO** | Lint・typecheck が GitHub Actions に無い | 品質ゲートが人力レビュー頼み |

---

## 2. リカバリ方針 ─ “壊さず寄せる” ３段階

> **◎ゴール**：30 日以内に「仕様書どおりの土台」が回り、以降はコンテンツ追加だけに集中できる状態へ。

### Phase 1 : **フレームワーク統一 & 開発体験整備**（Day 01-07）
1. **Astro プロジェクト新規作成**  
   ```bash
   pnpm create astro@latest kw-portfolio && cd kw-portfolio
   pnpm astro add tailwind@latest
   pnpm astro add mdx
   ```
2. **`tailwind.config.mjs` にテーマ色注入**（仕様書 §1.2）  
3. **`src/pages/` に `index.astro` だけコピー**  
   - 既存 Hero セクションを書き写し「ビルド成功」を確認。  
4. **CI 雛形追加**（`.github/workflows/site-deploy.yml`）  
   - `pnpm run lint && pnpm run typecheck` で fail させない所まで。  

### Phase 2 : **ディレクトリ再編 & データ駆動化**（Day 08-20）
1. **Atomic 階層を切る**  
   ```
   src/components/atoms/Button.astro
   src/components/molecules/Card.astro
   src/components/organisms/Hero.astro
   ```
2. **`data/proof.json` & zod スキーマ**  
   ```ts
   // data/schema/proof.ts
   import { z } from 'zod';
   export const ProofSchema = ...
   ```
3. **`ProofList.astro`** で `proof.json` を map → Card を生成。  
4. **`/[...slug].mdx` ルート** を作り、最初の Proof 記事 (`network/packet-capture.mdx`) を移植。  
5. **型 & ESLint を CI に組み込み**（lint, typecheck Job を追加）。  

### Phase 3 : **UX 完成度と SLO 達成**（Day 21-30）
1. **Lighthouse CI / Trivy / lychee Nightly**  
2. **Progress Dashboard (Progress.tsx)** を Landing に配置。  
3. **コード分割・画像最適化**で Lighthouse All ≥ 95。  
4. **Vercel から GitHub Pages へルート切り替え**（Custom ドメインが要る場合は逆でも可）。  

> **この段階で：** 仕様書の SLO 行はすべて “🟢 Pass” になり、以降は Proof や Story を足すだけの運用に移行できます。

---

## 3. あなたの具体的 TODO チェックリスト

- [ ] **Astro+Tailwind 雛形を別ブランチで起こす**（`astro-migration`）  
- [ ] **Hero, Navbar, Footer を移植 → ビルド通過**  
- [ ] **`components.d.ts` に Button/Card 型を宣言**  
- [ ] **`data/proof.json` に 1 件だけ書き、Card 生成を確認**  
- [ ] **GitHub Actions に Lint/Typecheck ジョブを置く**  
- [ ] **MDX 1 本を書いて `/proof/...` で表示確認**  
- [ ] **旧 Next.js フォルダを段階的に削除し、Vercel preview を停止**  

> **ワンポイント**  
> - 失敗しても *Git ブランチを切っておく* 限り本番には影響しません。  
> - Tailwind の「生色コード削除」を *VS Code global search* で一括置換すると効率爆上がりです。  
> - `justfile` を導入するとローカルタスク (`just dev`, `just lint`) を覚えやすくなります。

---

## 4. さらなる伴走のお願い

1. **GitHub リポジトリ（private 可）の URL** を共有 → _ブランチ構成 / CI ログ_ を一緒に眺めながら次の手を決められます。  
2. **「詰まったコミット」をピンポイントで教えてください。** `git push` されたハッシュを基に差分レビュー型のアドバイスを返します。  

「Astro でページが真っ白」「Tailwind クラスが効かない」等、**現象ベースの相談** にも即応しますので、遠慮なく投げてください。

### 結論 — **作り直しは不要。**  
現 GitHub リポジトリはすでに Astro/Tailwind で動いており、Proof 9 カテゴリのフォルダも存在します — **“骨格” は生きています。**  
ずれているのは

1. Atomic Design の階層と型定義がまだ無い  
2. Tailwind カラートークンが CSS 変数と二重化されていない  
3. `proof.json` + zod スキーマ駆動が未着手  
4. Lint / Type-check / Nightly CI が未整備  

なので **既存ブランチを壊さず、** 次のように“内側から” 揃えていくのが最速です。

---

## 🚀 移行ロードマップ（リポジトリ現状を前提）

> 下記は `main` に直接コミットせず、 **`refactor/v2` ブランチ** で進めましょう。  
> 完了ごとに PR→セルフレビュー→Squash merge の流れを固定にすると破壊リスクが 0 になります。

| フェーズ | 目安日数 | 完了判定 (PR タイトル例) |
|----------|----------|-------------------------|
| **Step 0**<br>足場確認 | 1 日 | `chore: add astro check & eslint to CI` — Actions が緑で通る |
| **Step 1**<br>Atomic 階層 & 型 | 2–3 日 | `refactor: move Button/Card to atoms & add types` |
| **Step 2**<br>Tailwind トークン同期 | 1 日 | `style: replace hard-coded colors with token classes` |
| **Step 3**<br>data/ スキーマ駆動 | 2–4 日 | `feat: proof.json + zod validation + dynamic ProofList` |
| **Step 4**<br>ページ深度の分離 | 3–5 日 | `feat: structure/ & story/ template routing complete` |
| **Step 5**<br>Nightly Heavy CI | 1–2 日 | `ci: add lighthouse, trivy, lychee nightly workflow` |

合計 **≈ 2 週間で“仕様書 v 2.0 準拠”** を狙えます。

---

## 📑 具体的作業メモ

### Step 0 — Lint / type-check を CI にのせる
```yaml
# .github/workflows/ci.yml
name: ci
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 8 }
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - run: pnpm typecheck   # astro check + tsc --noEmit
```
*`pnpm lint/typecheck` スクリプトは package.json に追加。*

---

### Step 1 — Atomic 階層と型定義
1. **移動**  
   ```
   src/components/
     └─ atoms/
         ├─ Button.astro
         └─ Badge.astro
     └─ molecules/
         └─ Card.astro
   ```
2. **型ファイル** `src/types/components.d.ts` を作成（仕様書 §2.1 のまま）。
3. **import の書き換え**  
   `import Button from '@/components/atoms/Button.astro';`

---

### Step 2 — Tailwind トークン同期
*tailwind.config.mjs* の `theme.extend.colors` を仕様書値に差し替え、  
`globals.css` 冒頭で同名 CSS Variables を宣言。

```css
:root{
  --bg-start:#0d1b2a; --bg-mid:#162d46; --bg-end:#0a2540;
  --text:#e0e7ff; --accent:#61dafb; --card-bg:#112240; --card-accent:#64ffda;
}
```
VS Code の正規表現置換で  
`bg-#0d1b2a` → `bg-bg-start` などを一括変換すると時短。

---

### Step 3 — data/ 駆動

1. `data/proof.json`
   ```json
   [
     {
       "slug":"network-security/packet-capture",
       "title":"Packet Capture Lab",
       "difficulty":"easy",
       "updated":"2025-04-27",
       "tags":["pcap","wireshark"]
     }
   ]
   ```
2. `data/schema/proof.ts` に zod を実装し、 Astro `src/scripts/validate.ts` で parse。  
3. **動的一覧**  
   `src/components/organisms/ProofList.astro` で
   ```astro
   ---
   import data from '@/data/proof.json';
   ---
   {data.map(p => <Card title={p.title} link={`/proof/${p.slug}`} />)}
   ```

---

### Step 4 — ルーティング深度

```
src/pages/
  index.astro               (Landing)
  structure/index.astro     (Depth2)
  proof/index.astro         (Depth3 一覧)
  proof/[...slug].mdx       (Depth3 記事)
  story/index.astro         (Depth4 タイムライン)
  story/[...slug].mdx       (Depth4 記事)
```
*Catch-all MDX で、Proof/Story 記事を GitHub PR 単位で追加できる仕組みに。*

---

### Step 5 — Nightly Heavy

`.github/workflows/nightly.yml`
```yaml
on:
  schedule: [{ cron: '0 18 * * *' }]  # JST 深夜3時
jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with: { version: 8 }
      - run: pnpm install --frozen-lockfile
      - run: pnpm build
      - name: Lighthouse
        uses: treosh/lighthouse-ci-action@v10
        with: { urls: 'https://kwstyk-portfolio.vercel.app' }
      - name: Trivy
        run: trivy fs --severity CRITICAL,HIGH --exit-code 1 .
      - name: lychee
        run: npx lychee -a .
```
Slack 通知は `SLACK_WEBHOOK` シークレットで追加可能。

---

## ❓「Astro を消して Next.js に戻る必要は…？」  
**ありません。** 現状リポジトリは Astro 56 %、CSS 41 % で Next.js の痕跡は無いため、  
*作り直し* はコスト対効果が低いです。  
*既存の `dist/` フォルダや不要 CSS は移行途中で削除* しつつ、上記ステップを進めれば **二週間で完全合流** できます。

---

### 次のアクション
1. `refactor/v2` ブランチを切る  
2. **Step 0** の CI／Lint を push → Actions 緑確認  
3. そこでハマったらコミット SHA とともに「ここで赤くなった」とご相談ください。  
　（差分レビューでピンポイント支援します）

これで **“破壊せず導く”** ルートが明確になりました。  
つまずいた箇所は都度スクショやログを貼って呼んでください—最短で軌道修正します。