services:
  # â‘  ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚µãƒ¼ãƒ
  base:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: linux-secure-baseline_base
    ports:
      - "2222:22"      # SSH å¤–å‡ºã—
    tty: true
    privileged: true

  # â‘¡ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© & ç›£æŸ»ãƒ©ãƒ³ãƒŠãƒ¼
  controller:
    build:
      context: .
      dockerfile: Dockerfile.controller
    volumes:
      - .:/work
    working_dir: /work
    depends_on:
      - base
    entrypoint:
      - /bin/bash
      - -c
      - |
        set -e

        echo 'ğŸ“ Pre-audit'
        sshpass -p root ssh -o StrictHostKeyChecking=no root@base \
          lynis audit system --quiet --auditor pre --logfile /var/log/lynis-pre.log

        # â† ã“ã“ã§â€œæ”¹å–„å‰â€ã‚¹ã‚³ã‚¢ã‚’å–å¾—
        echo -e '\n=== Hardening index (before) ==='
        sshpass -p root ssh -o StrictHostKeyChecking=no root@base \
          "grep -m1 'Hardening index' /var/log/lynis-pre.log" || true

        echo -e '\nğŸš€ Applying hardening via Ansible'
        ansible-playbook -i ansible/inventory ansible/playbook.yml

        echo -e '\nğŸ“ Post-audit'
        sshpass -p root ssh -o StrictHostKeyChecking=no root@base \
          lynis audit system --quiet --auditor post --logfile /var/log/lynis-post.log
        
        # â† ãã—ã¦â€œæ”¹å–„å¾Œâ€ã‚¹ã‚³ã‚¢ã‚’å†å–å¾—
        echo -e '\n=== Hardening index (after) ==='
        sshpass -p root ssh -o StrictHostKeyChecking=no root@base \
          "grep -m1 'Hardening index' /var/log/lynis-post.log" || true

        exit 0
